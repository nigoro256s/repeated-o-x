<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;900&family=Stick&display=swap"
        rel="stylesheet">
    <title>まるばつるーぷ！</title>
    <style>
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-family: 'Stick', sans-serif;
        }

        .game {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }

        #canvas {
            width: calc(min(90vw, 90vh));
            box-shadow: 0px 0px 10px 5px rgb(192, 192, 192);
        }

        .texts {
            text-align: center;
            font-size: 200%;
        }
    </style>
</head>

<body>
    <div class="game">
        <div class="wrapper">
            <canvas id="canvas" width="600" height="600"></canvas>
        </div>
    </div>
    <div class="texts">
        まるばつるーぷ！ ベータ版
    </div>
    <script>
        var can = document.getElementById("canvas");
        var con = can.getContext("2d");
        var chara = new Image();
        chara.src = "board.png";
        chara.onload = () => {
            con.drawImage(chara, 0, 0);
        };
        var charab = new Image();
        charab.src = "blue.png";
        var charar = new Image();
        charar.src = "red.png";
        function drawboard() {
            con.globalAlpha = 1;
            con.drawImage(chara, 0, 0);
        }
        function drawo(xpos, ypos) {
            con.globalAlpha = 1;
            con.drawImage(charab, 170 + xpos * 100, 170 + ypos * 100);
        }
        function drawx(xpos, ypos) {
            con.globalAlpha = 1;
            con.drawImage(charar, 170 + xpos * 100, 170 + ypos * 100);
        }
        var charabs = new Image();
        charabs.src = "blues.png";
        var charars = new Image();
        charars.src = "reds.png";
        function eioe(t) {
            ret = 0;
            if (0 < t && t < 0.5) {
                ret = Math.pow(2, 20 * t - 10) / 2;
            }
            else if (t < 1) {
                ret = (2 - Math.pow(2, -20 * t + 10)) / 2;
            }
            else {
                ret = 1
            }
            return ret;
        }
        function mod(i, j) {
            return (i % j) < 0 ? (i % j) + 0 + (j < 0 ? -j : j) : (i % j + 0);
        }
        can.addEventListener('click', onClick, false);
        //
        canplay = true;
        var turn = -1;
        var state = [0, 0, 0, 0, 0, 0, 0, 0, 0];
        var laststate = [];
        var timer = 0;
        var dir = [1, 1];
        var posnum = 0;
        var result = 0;
        //
        function onClick(e) {
            var gameend = true;
            state.forEach(function (element) {
                if (element == 0) {
                    gameend = false;
                }
            });
            if (result != 0 || gameend) {
                result = 0;
                state = [0, 0, 0, 0, 0, 0, 0, 0, 0];
                trun = -1;
                con.clearRect(0, 0, 600, 600);
                drawboard();
            }
            else if (canplay) {
                var clickedx = Math.floor((e.clientX - canvas.offsetLeft - 0.25 * can.clientWidth) * 6 / can.clientWidth);
                var clickedy = Math.floor((e.clientY - canvas.offsetTop - 0.25 * can.clientHeight) * 6 / can.clientHeight);
                posnum = clickedx + 3 * clickedy;
                if (0 <= clickedx && clickedx <= 2 && 0 <= clickedy && clickedy <= 2 && state[posnum] == 0) {
                    canplay = false;
                    state[posnum] = turn;
                    timer = 0;
                    dirs = [[-1, -1], [0, -1], [1, -1], [-1, 0], [0, 0], [1, 0], [-1, 1], [0, 1], [1, 1]];
                    dir = dirs[posnum];
                    var statecopy = Array.from(state);
                    laststate = Array.from(state);
                    var delta = [[8, 6, 7, 2, 0, 1, 5, 3, 4],
                    [6, 7, 8, 0, 1, 2, 3, 4, 5],
                    [7, 8, 6, 1, 2, 0, 4, 5, 3],
                    [2, 0, 1, 5, 3, 4, 8, 6, 7],
                    [0, 1, 2, 3, 4, 5, 6, 7, 8],
                    [1, 2, 0, 4, 5, 3, 7, 8, 6],
                    [5, 3, 4, 8, 6, 7, 2, 0, 1],
                    [3, 4, 5, 6, 7, 8, 0, 1, 2],
                    [4, 5, 3, 7, 8, 6, 1, 2, 0]];
                    for (var i = 0; i <= 8; i++) {
                        state[delta[posnum][i]] = statecopy[i];
                    }
                    if (state[0] + state[1] + state[2] == 3 || state[3] + state[4] + state[5] == 3 || state[6] + state[7] + state[8] == 3 || state[0] + state[3] + state[6] == 3 || state[1] + state[4] + state[7] == 3 || state[2] + state[5] + state[8] == 3 || state[0] + state[4] + state[8] == 3 || state[2] + state[4] + state[6] == 3) {
                        result = 1;
                    }
                    else if (state[0] + state[1] + state[2] == -3 || state[3] + state[4] + state[5] == -3 || state[6] + state[7] + state[8] == -3 || state[0] + state[3] + state[6] == -3 || state[1] + state[4] + state[7] == -3 || state[2] + state[5] + state[8] == -3 || state[0] + state[4] + state[8] == -3 || state[2] + state[4] + state[6] == -3) {
                        result = -1;
                    }
                    translate();
                }
            }
        }
        function translate() {
            con.clearRect(0, 0, 600, 600);
            var ease = eioe(timer / 60);
            for (var k = -1; k <= 1; k++) {
                for (var j = -1; j <= 1; j++) {
                    for (var i = 0; i <= 9; i++) {
                        if (laststate[i] == 1) {
                            drawo(i % 3 + dir[0] * ease + 3 * k, Math.floor(i / 3) + dir[1] * ease + 3 * j);
                        }
                        else if (laststate[i] == -1) {
                            drawx(i % 3 + dir[0] * ease + 3 * k, Math.floor(i / 3) + dir[1] * ease + 3 * j);
                        }
                    }
                }
            }
            timer++;
            if (timer <= 60 && posnum != 4) {
                drawboard();
                if (result == 1) {
                    con.globalAlpha = ease;
                    con.drawImage(charabs, 100, 100);
                }
                else if (result == -1) {
                    con.globalAlpha = ease;
                    con.drawImage(charars, 100, 100);
                }
                requestAnimationFrame(translate);
            }
            else {
                canplay = true;
                turn *= -1;
                drawboard();
                if (result == 1) {
                    con.globalAlpha = 1;
                    con.drawImage(charabs, 100, 100);
                }
                else if (result == -1) {
                    con.globalAlpha = 1;
                    con.drawImage(charars, 100, 100);
                }
            }
        }
    </script>
</body>

</html>